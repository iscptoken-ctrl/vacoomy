<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Vacoomy</title>
<style>
    body {
        margin: 0;
        overflow: hidden;
        background: #111;
        font-family: Arial, sans-serif;
        color: white;
        text-align: center;
    }
    #usernameScreen, #gameOverScreen {
        position: absolute;
        width: 100%;
        height: 100%;
        background: #111;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10;
    }
    #gameCanvas {
        display: none;
    }
    input {
        padding: 10px;
        font-size: 20px;
        width: 220px;
    }
    button {
        padding: 12px 20px;
        margin-top: 15px;
        font-size: 20px;
        cursor: pointer;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- Username Screen -->
<div id="usernameScreen">
    <h1>Vacoomy</h1>
    <p>Choose a username</p>
    <input id="usernameInput" placeholder="Username" />
    <button onclick="startGame()">Start</button>
</div>

<!-- Game Over Screen -->
<div id="gameOverScreen" style="display:none;">
    <h1>Game Over</h1>
    <p id="finalScore"></p>
    <h3>Global Ranking</h3>
    <div id="rankingList">Loading...</div>
    <button onclick="restart()">Play Again</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
/* -----------------------------
   SUPABASE CONFIG
------------------------------ */
const SUPABASE_URL = "https://rwpzycqetqfeasveviho.supabase.co";
const SUPABASE_KEY = "sb_publishable_Bx5RBH5HrKmz8p8YRRH--Q_s-AYrwvt";
const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_KEY);

/* -----------------------------
   GAME SETUP
------------------------------ */
let canvas, ctx;
let robot = { x: 300, y: 300, size: 32, angle: 0 };
let numbers = [];
let keys = {};
let score = 0;
let timeLeft = 120;
let username = "";

function startGame() {
    username = document.getElementById("usernameInput").value.trim();
    if (!username) return;

    document.getElementById("usernameScreen").style.display = "none";

    canvas = document.getElementById("gameCanvas");
    canvas.style.display = "block";
    ctx = canvas.getContext("2d");
    resize();

    score = 0;
    timeLeft = 120;
    numbers = [];
    spawnNumbers();
    setInterval(spawnNumbers, 700);

    window.addEventListener("keydown", (e) => keys[e.key] = true);
    window.addEventListener("keyup", (e) => keys[e.key] = false);

    gameLoop();
    countdown();
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

/* -----------------------------
   GAME LOOP
------------------------------ */
function gameLoop() {
    update();
    draw();
    if (timeLeft > 0) requestAnimationFrame(gameLoop);
}

function update() {
    // WASD movement only
    if (keys["w"]) robot.y -= 3;
    if (keys["s"]) robot.y += 3;
    if (keys["a"]) robot.x -= 3;
    if (keys["d"]) robot.x += 3;

    // Rotate toward mouse pointer?
    // Instead rotate toward movement
    if (keys["w"]) robot.angle = 270;
    if (keys["s"]) robot.angle = 90;
    if (keys["a"]) robot.angle = 180;
    if (keys["d"]) robot.angle = 0;

    // Pull numbers
    numbers.forEach((n, i) => {
        let dx = robot.x - n.x;
        let dy = robot.y - n.y;
        let dist = Math.sqrt(dx*dx + dy*dy);

        if (dist < 120) {
            n.x += dx * 0.05;
            n.y += dy * 0.05;
        }

        if (dist < 25) {
            score += n.value;
            numbers.splice(i, 1);
        }
    });
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Draw robot emoji
    ctx.save();
    ctx.translate(robot.x, robot.y);
    ctx.rotate(robot.angle * Math.PI/180);
    ctx.font = `${robot.size}px serif`;
    ctx.fillText("ðŸ¤–", -robot.size/2, robot.size/2);
    ctx.restore();

    // Draw visible attraction field (cone)
    ctx.save();
    ctx.translate(robot.x, robot.y);
    ctx.rotate(robot.angle * Math.PI/180);
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(140, -40);
    ctx.lineTo(140, 40);
    ctx.closePath();
    ctx.strokeStyle = "rgba(0,255,255,0.4)";
    ctx.stroke();
    ctx.restore();

    // Draw numbers
    numbers.forEach(n => {
        ctx.font = "26px Arial";
        ctx.fillStyle = "white";
        ctx.fillText(n.value, n.x, n.y);
    });

    // HUD
    ctx.font = "24px Arial";
    ctx.fillStyle = "white";
    ctx.fillText("Score: " + score, 20, 40);
    ctx.fillText("Time: " + timeLeft, 20, 70);
}

function spawnNumbers() {
    if (timeLeft <= 0) return;

    numbers.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        value: Math.floor(Math.random()*9)+1
    });
}

/* -----------------------------
   TIMER + GAME END
------------------------------ */
function countdown() {
    let t = setInterval(() => {
        timeLeft--;
        if (timeLeft <= 0) {
            clearInterval(t);
            endGame();
        }
    }, 1000);
}

async function endGame() {
    canvas.style.display = "none";
    document.getElementById("gameOverScreen").style.display = "flex";
    document.getElementById("finalScore").innerText = `Your Score: ${score}`;

    // Save score
    await supabase.from("scores").insert({ username, score });

    loadRanking();
}

/* -----------------------------
   LOAD GLOBAL RANKING
------------------------------ */
async function loadRanking() {
    let box = document.getElementById("rankingList");
    box.innerHTML = "Loading...";

    let { data, error } = await supabase
        .from("scores")
        .select("*")
        .order("score", { ascending: false })
        .limit(10);

    if (error) {
        box.innerHTML = "Ranking error";
        return;
    }

    box.innerHTML = data.map(r => `${r.username}: ${r.score}`).join("<br>");
}

/* -----------------------------
   RESTART
------------------------------ */
function restart() {
    document.location.reload();
}

window.onresize = resize;
</script>

</body>
</html>
