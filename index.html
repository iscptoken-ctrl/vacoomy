<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vacoomy</title>
<style>
    body {
        margin:0;
        background:#1a1a1a;
        color:white;
        font-family:Arial, sans-serif;
        overflow:hidden;
        text-align:center;
    }
    #menu, #game, #rankingScreen {
        display:none;
    }
    #usernameInput {
        padding:10px;
        font-size:18px;
        width:200px;
    }
    #gameArea {
        margin:0 auto;
        margin-top:20px;
        width:380px;
        height:380px;
        background:#222;
        border:3px solid #444;
        position:relative;
        overflow:hidden;
    }
    .number {
        position:absolute;
        font-size:22px;
        font-weight:bold;
        color:#ffe680;
    }
    #robot {
        position:absolute;
        font-size:40px;
        transform: translate(-50%, -50%);
    }
    #cone {
        position:absolute;
        width:120px;
        height:120px;
        background:rgba(255,255,0,0.25);
        clip-path: polygon(0 50%, 100% 0, 100% 100%);
        transform-origin:left center;
    }
    #timer, #scoreDisplay {
        font-size:20px;
        margin-top:10px;
    }
    button {
        padding:12px 24px;
        background:#4CAF50;
        color:white;
        border:none;
        border-radius:6px;
        font-size:18px;
        margin-top:10px;
        cursor:pointer;
    }
</style>
</head>
<body>

<div id="menu">
    <h2>Vacoomy</h2>
    <p>Enter username</p>
    <input id="usernameInput" placeholder="your name">
    <br><button onclick="startGame()">Start</button>
</div>

<div id="game">
    <div id="timer"></div>
    <div id="scoreDisplay"></div>
    <div id="gameArea">
        <div id="cone"></div>
        <div id="robot">ðŸ¤–</div>
    </div>
</div>

<div id="rankingScreen">
    <h2>Game Over</h2>
    <p id="finalScore"></p>
    <h3>Global Ranking</h3>
    <div id="rankingList">Loading...</div>
    <button onclick="returnToMenu()">Play Again</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

// ---------------- SUPABASE ------------------

const SUPABASE_URL = "https://rwpzycqetqfeasveviho.supabase.co";
const SUPABASE_KEY = "sb_publishable_Bx5RBH5HrKmz8p8YRRH--Q_s-AYrwvt";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ---------------- GAME VARIABLES ------------------

let username = "";
let score = 0;
let timeLeft = 120;
let robotX = 190, robotY = 190;
let speed = 3;
let dirX = 0, dirY = 0;
let spawnInterval;
let timerInterval;

document.addEventListener("keydown", (e)=>{
    if(e.key === "w") dirY = -1;
    if(e.key === "s") dirY = 1;
    if(e.key === "a") dirX = -1;
    if(e.key === "d") dirX = 1;
});
document.addEventListener("keyup", (e)=>{
    if(e.key === "w" || e.key === "s") dirY = 0;
    if(e.key === "a" || e.key === "d") dirX = 0;
});

// ---------------- START GAME ------------------

function startGame(){
    username = document.getElementById("usernameInput").value.trim();
    if(username.length < 2){
        alert("Username must be at least 2 characters");
        return;
    }

    document.getElementById("menu").style.display="none";
    document.getElementById("game").style.display="block";

    score = 0;
    timeLeft = 120;
    robotX = 190;
    robotY = 190;

    document.getElementById("scoreDisplay").innerText = "Score: 0";
    document.getElementById("timer").innerText = "Time: 120";

    spawnInterval = setInterval(spawnNumber, 700);
    timerInterval = setInterval(updateTimer, 1000);

    requestAnimationFrame(gameLoop);
}

// ---------------- NUMBER SPAWN ------------------

function spawnNumber(){
    const gameArea = document.getElementById("gameArea");
    const div = document.createElement("div");
    div.className = "number";

    const value = Math.floor(Math.random()*9)+1;
    div.innerText = value;

    div.style.left = (Math.random()*340)+"px";
    div.style.top = (Math.random()*340)+"px";

    gameArea.appendChild(div);

    setTimeout(()=>div.remove(), 4000);
}

// ---------------- GAME LOOP ------------------

function gameLoop(){
    robotX += dirX * speed;
    robotY += dirY * speed;

    robotX = Math.max(20, Math.min(360, robotX));
    robotY = Math.max(20, Math.min(360, robotY));

    const robot = document.getElementById("robot");
    robot.style.left = robotX+"px";
    robot.style.top = robotY+"px";

    const angle = Math.atan2(dirY, dirX) * 180 / Math.PI;
    const cone = document.getElementById("cone");
    cone.style.left = robotX+"px";
    cone.style.top = robotY+"px";
    cone.style.transform = `rotate(${angle}deg)`;

    absorbNumbers();

    requestAnimationFrame(gameLoop);
}

// ---------------- ABSORB NUMBERS ------------------

function absorbNumbers(){
    const nums = document.querySelectorAll(".number");

    nums.forEach(n=>{
        const nx = parseFloat(n.style.left);
        const ny = parseFloat(n.style.top);

        const dx = nx - robotX;
        const dy = ny - robotY;
        const dist = Math.sqrt(dx*dx + dy*dy);

        if(dist < 50){
            score += parseInt(n.innerText);
            n.remove();
            document.getElementById("scoreDisplay").innerText = "Score: " + score;
        }
    });
}

// ---------------- TIMER ------------------

function updateTimer(){
    timeLeft--;
    document.getElementById("timer").innerText = "Time: " + timeLeft;

    if(timeLeft <= 0){
        endGame();
    }
}

// ---------------- END GAME ------------------

async function endGame(){

    clearInterval(spawnInterval);
    clearInterval(timerInterval);

    document.getElementById("game").style.display="none";
    document.getElementById("rankingScreen").style.display="block";

    document.getElementById("finalScore").innerText = "Your Score: " + score;

    // Save to Supabase
    await db.from("scores").insert({
        username: username,
        score: score
    });

    loadRanking();
}

// ---------------- LOAD RANKING ------------------

async function loadRanking(){
    const list = document.getElementById("rankingList");
    list.innerHTML = "Loading...";

    let { data, error } = await db
        .from("scores")
        .select("*")
        .order("score", { ascending:false })
        .limit(10);

    if(error){
        list.innerHTML = "Error loading ranking";
        return;
    }

    list.innerHTML = "";
    data.forEach((r, i)=>{
        list.innerHTML += `<div>${i+1}. ${r.username} â€” ${r.score}</div>`;
    });
}

function returnToMenu(){
    document.getElementById("rankingScreen").style.display="none";
    document.getElementById("menu").style.display="block";
}

</script>
</body>
</html>
