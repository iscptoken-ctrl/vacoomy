<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vacoomy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        margin: 0;
        overflow: hidden;
        background: #222;
        font-family: Arial, sans-serif;
        color: white;
    }

    #ui {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        font-size: 20px;
    }

    #startScreen, #gameOverScreen, #rankingScreen {
        position: absolute;
        top: 0; left: 0;
        width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.85);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 26px;
        z-index: 20;
    }

    button {
        padding: 12px 30px;
        font-size: 20px;
        margin-top: 20px;
        cursor: pointer;
    }

    canvas {
        background: #333;
        display: block;
    }
</style>
</head>

<body>

<div id="ui">
    <div id="timer">Time: 120</div>
    <div id="score">Score: 0</div>
</div>

<div id="startScreen">
    <h1>ðŸ§¹ Vacoomy</h1>
    <p>WASD ile hareket et. 2 dakikada en yÃ¼ksek skoru topla!</p>
    <button onclick="startGame()">Start</button>
</div>

<div id="gameOverScreen" style="display:none;">
    <h1>Game Over</h1>
    <div id="finalScore"></div>
    <button onclick="restartGame()">Restart</button>
    <button onclick="showRanking()">Ranking</button>
</div>

<div id="rankingScreen" style="display:none;">
    <h1>Top Scores</h1>
    <div id="rankingList"></div>
    <button onclick="closeRanking()">Close</button>
</div>

<canvas id="game"></canvas>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

//////////////////////////////////////////
// SUPABASE SETUP
//////////////////////////////////////////

const SUPABASE_URL = "https://rwpzycqetqfeasveviho.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3cHp5Y3FldHFmZWFzdmV2aWhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMzEwOTYsImV4cCI6MjA4MDcwNzA5Nn0.Rj0zvPhqgfJBIcp_RA6kmRj-vLpBumz-Tu0BNRQoKmI";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


//////////////////////////////////////////
// GAME VARIABLES
//////////////////////////////////////////

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let player = { x: 200, y: 200, size: 40, speed: 4 };
let score = 0;
let timeLeft = 120;
let numbers = [];
let keys = {};

let gameRunning = false;


//////////////////////////////////////////
// EVENTS
//////////////////////////////////////////

document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);


//////////////////////////////////////////
// GAME LOOP
//////////////////////////////////////////

function spawnNumber() {
    if (!gameRunning) return;
    numbers.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        value: Math.floor(Math.random() * 9) + 1
    });

    setTimeout(spawnNumber, 300); // sÄ±k spawn olsun
}

function update() {
    if (!gameRunning) return;

    if (keys["w"]) player.y -= player.speed;
    if (keys["s"]) player.y += player.speed;
    if (keys["a"]) player.x -= player.speed;
    if (keys["d"]) player.x += player.speed;

    numbers = numbers.filter(n => {
        let d = Math.hypot(n.x - player.x, n.y - player.y);
        if (d < 50) {
            score += n.value;
            document.getElementById("score").innerText = "Score: " + score;
            return false;
        }
        return true;
    });
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // sÃ¼pÃ¼rge (robot)
    ctx.font = "40px Arial";
    ctx.fillText("ðŸ¤–", player.x - 20, player.y + 20);

    numbers.forEach(n => {
        ctx.fillStyle = "yellow";
        ctx.font = "28px Arial";
        ctx.fillText(n.value, n.x, n.y);
    });

    requestAnimationFrame(draw);
}

setInterval(update, 16);


//////////////////////////////////////////
// TIMER + GAME END
//////////////////////////////////////////

function startTimer() {
    let interval = setInterval(async () => {
        if (!gameRunning) return clearInterval(interval);

        timeLeft--;
        document.getElementById("timer").innerText = "Time: " + timeLeft;

        if (timeLeft <= 0) {
            gameRunning = false;
            clearInterval(interval);
            endGame();
        }
    }, 1000);
}

async function endGame() {
    document.getElementById("gameOverScreen").style.display = "flex";
    document.getElementById("finalScore").innerText =
        "Your Score: " + score;

    // Supabase'e kaydet
    await supabase.from("scores").insert([
        { username: "player" + Math.floor(Math.random()*9999), score: score }
    ]);
}


//////////////////////////////////////////
// START / RESTART
//////////////////////////////////////////

function startGame() {
    score = 0;
    timeLeft = 120;
    numbers = [];
    gameRunning = true;

    document.getElementById("startScreen").style.display = "none";
    document.getElementById("gameOverScreen").style.display = "none";

    document.getElementById("score").innerText = "Score: 0";
    document.getElementById("timer").innerText = "Time: 120";

    spawnNumber();
    startTimer();
}

function restartGame() {
    startGame();
}


//////////////////////////////////////////
// RANKING
//////////////////////////////////////////

async function showRanking() {
    document.getElementById("rankingScreen").style.display = "flex";

    const { data } = await supabase
        .from("scores")
        .select("*")
        .order("score", { ascending: false })
        .limit(20);

    let html = "";
    data.forEach((row, i) => {
        html += `<div>${i+1}. ${row.username} â€” ${row.score}</div>`;
    });

    document.getElementById("rankingList").innerHTML = html;
}

function closeRanking() {
    document.getElementById("rankingScreen").style.display = "none";
}


//////////////////////////////////////////
// START DRAWING
//////////////////////////////////////////
draw();

</script>
</body>
</html>
