<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vacoomy</title>
<style>
  body { display: flex; justify-content: center; align-items: center; height: 100vh; background: #eee; position: relative; margin:0; font-family: Arial, sans-serif; }
  #gameCanvas { background: #fff; border: 2px solid #000; touch-action: none; display: none; }
  #score, #timer { position: absolute; font-size: 20px; font-weight: bold; }
  #score { top: 10px; left: 10px; }
  #timer { top: 10px; right: 10px; }
  #overlay { position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);color:white;display:flex;justify-content:center;align-items:center;flex-direction:column; font-size:24px; }
  #overlay button { margin-top:20px; font-size:20px; padding:10px 20px; cursor:pointer; }
</style>
</head>
<body>

<div id="score">Puan: 0</div>
<div id="timer">02:00</div>
<canvas id="gameCanvas" width="600" height="600" tabindex="0"></canvas>

<div id="overlay">
  <div id="message">Vacoomy</div>
  <button id="startBtn">Start</button>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreDisplay = document.getElementById('score');
const timerDisplay = document.getElementById('timer');
const overlay = document.getElementById('overlay');
const message = document.getElementById('message');
const startBtn = document.getElementById('startBtn');

let vacuum = { x: 300, y: 300, size: 40, emoji: "" };
let numbers = [];
let score = 0;
let totalTime = 120; // 2 dakika
let elapsedTime = 0;
let gameRunning = false;

// Mobil hedef
let targetX = null;
let targetY = null;

// Spawn rakamlar覺
function spawnNumbers() {
  if(!gameRunning) return;
  for(let i=0;i<3;i++){
    const value = Math.floor(Math.random() * 9) + 1;
    numbers.push({
      x: Math.random() * (canvas.width - 20),
      y: Math.random() * (canvas.height - 20),
      value: value,
      ttl: value * 60
    });
  }
}
let spawnInterval;

// Start butonu
startBtn.addEventListener('click', ()=>{
  overlay.style.display = 'none';
  canvas.style.display = 'block';
  resetGame();
  gameRunning = true;
  spawnInterval = setInterval(spawnNumbers, 500);
});

// Reset oyun
function resetGame() {
  vacuum.x = 300;
  vacuum.y = 300;
  numbers = [];
  score = 0;
  elapsedTime = 0;
  targetX = null;
  targetY = null;
  scoreDisplay.textContent = `Puan: ${score}`;
  timerDisplay.textContent = `02:00`;
}

// izim fonksiyonlar覺
function drawVacuum() {
  ctx.fillStyle = 'rgba(0,0,255,0.2)';
  ctx.beginPath();
  ctx.arc(vacuum.x, vacuum.y, 50, 0, Math.PI*2);
  ctx.fill();

  ctx.font = `${vacuum.size}px Arial`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(vacuum.emoji, vacuum.x, vacuum.y);
}

function drawNumbers() {
  numbers.forEach(num => {
    ctx.fillStyle = 'red';
    ctx.font = '20px Arial';
    ctx.fillText(num.value, num.x, num.y);
    num.ttl--;
  });
  numbers = numbers.filter(num => num.ttl > 0);
}

// Klavye kontrolleri (WASD)
let keys = {};
canvas.addEventListener('keydown', e => {
  const key = e.key.toLowerCase();
  if(["w","a","s","d"].includes(key)) keys[key] = true;
});
canvas.addEventListener('keyup', e => {
  const key = e.key.toLowerCase();
  if(["w","a","s","d"].includes(key)) keys[key] = false;
});

// Mobil kontrol
canvas.addEventListener('touchstart', e => {
  const rect = canvas.getBoundingClientRect();
  targetX = e.touches[0].clientX - rect.left;
  targetY = e.touches[0].clientY - rect.top;
});
canvas.addEventListener('touchmove', e => {
  const rect = canvas.getBoundingClientRect();
  targetX = e.touches[0].clientX - rect.left;
  targetY = e.touches[0].clientY - rect.top;
});

// Global ranking fonksiyonu
async function saveScoreGlobal(score){
  try {
    await fetch("/api/save-score", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ score })
    });
  } catch(e){
    console.error("Skor g繹nderilemedi", e);
  }
}

async function showRankingGlobal(){
  try {
    const res = await fetch("/api/get-ranking");
    const data = await res.json();
    alert("Global Ranking:\n" + data.ranking.map((s,i)=>`${i+1}. ${s}`).join("\n"));
  } catch(e){
    console.error("Ranking al覺namad覺", e);
  }
}

// G羹ncelleme
function update() {
  if(!gameRunning) return;

  // WASD hareketi
  if(keys["w"]) vacuum.y -= 5;
  if(keys["s"]) vacuum.y += 5;
  if(keys["a"]) vacuum.x -= 5;
  if(keys["d"]) vacuum.x += 5;

  // Mobil hareket
  if(targetX !== null && targetY !== null) {
    const dx = targetX - vacuum.x;
    const dy = targetY - vacuum.y;
    vacuum.x += dx * 0.05;
    vacuum.y += dy * 0.05;
  }

  // S覺n覺rlar
  vacuum.x = Math.max(0, Math.min(canvas.width, vacuum.x));
  vacuum.y = Math.max(0, Math.min(canvas.height, vacuum.y));

  // Rakam 癟ekimi
  numbers.forEach((num, i) => {
    const dxn = vacuum.x - num.x;
    const dyn = vacuum.y - num.y;
    const dist = Math.hypot(dxn, dyn);

    if(dist < 50) {
      num.x += dxn * 0.05;
      num.y += dyn * 0.05;
    }

    if(dist < 25) {
      score += num.value;
      numbers.splice(i,1);
    }
  });

  scoreDisplay.textContent = `Puan: ${score}`;

  // Timer
  elapsedTime++;
  const remaining = Math.max(0, totalTime - Math.floor(elapsedTime / 60));
  const minutes = String(Math.floor(remaining / 60)).padStart(2,'0');
  const seconds = String(remaining % 60).padStart(2,'0');
  timerDisplay.textContent = `${minutes}:${seconds}`;

  // Oyun bitii
  if(remaining <= 0){
    gameRunning = false;
    clearInterval(spawnInterval);
    saveScoreGlobal(score);       // Global skor kaydet
    overlay.style.display = 'flex';
    message.textContent = `Oyun Bitti! Skor: ${score}`;
    startBtn.textContent = "Tekrar Oyna";
    showRankingGlobal();          // Global ranking g繹ster
  }
}

// D繹ng羹
function loop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  update();
  drawVacuum();
  drawNumbers();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
