<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Vacoomy</title>
<style>
    body {
        margin:0;
        background:#111;
        color:white;
        font-family:Arial;
        overflow:hidden;
    }
    #ui, #game, #ranking {
        position:absolute;
        top:0; left:0; width:100%; height:100%;
        display:flex;
        justify-content:center;
        align-items:center;
        flex-direction:column;
    }
    #game { display:none; }
    #ranking { display:none; }
    canvas {
        background:#1a1a1a;
        border:2px solid #444;
    }
    input {
        padding:10px;
        width:180px;
        margin-bottom:10px;
    }
    button {
        padding:10px 20px;
        margin:5px;
        font-size:16px;
        cursor:pointer;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<div id="ui">
    <h1>Vacoomy</h1>
    <p>Enter username</p>
    <input id="usernameInput" placeholder="Your name">
    <button id="startBtn">Start</button>
</div>

<div id="game">
    <canvas id="canvas" width="600" height="600"></canvas>
    <h2 id="timer">Time: 120</h2>
    <h2 id="scoreText">Score: 0</h2>
</div>

<div id="ranking">
    <h1>Global Ranking</h1>
    <div id="rankList">Loading...</div>
    <button onclick="restart()">Play Again</button>
</div>

<script>
/* ---------------- SUPABASE CONFIG ---------------- */
const supabase = supabasejs.createClient(
    "https://rwpzycqetqfeasveviho.supabase.co",
    "sb_publishable_Bx5RBH5HrKmz8p8YRRH--Q_s-AYrwvt"
);

/* ---------------- GAME VARS ---------------- */
let username = "";
let canvas, ctx;
let player = { x:300, y:300, size:20, speed:3, angle:0 };
let keys = {};
let numbers = [];
let score = 0;
let timeLeft = 120;
let interval;

/* ---------------- START FLOW ---------------- */
document.getElementById("startBtn").onclick = () => {
    username = document.getElementById("usernameInput").value.trim();
    if(!username){ alert("Enter username!"); return; }

    document.getElementById("ui").style.display="none";
    document.getElementById("game").style.display="flex";

    startGame();
};

/* ---------------- GAME LOOP ---------------- */
function startGame(){
    canvas = document.getElementById("canvas");
    ctx = canvas.getContext("2d");
    score = 0;
    timeLeft = 120;
    numbers=[];
    spawnLoop();
    interval = setInterval(gameLoop, 16);
    timerTick();
}

function timerTick(){
    let t = setInterval(()=>{
        timeLeft--;
        document.getElementById("timer").innerText="Time: "+timeLeft;
        if(timeLeft<=0){
            clearInterval(t);
            endGame();
        }
    },1000);
}

function spawnLoop(){
    setInterval(()=>{
        numbers.push({
            x: Math.random()*580+10,
            y: Math.random()*580+10,
            value: Math.floor(Math.random()*9)+1
        });
    },400); // lots of numbers
}

document.addEventListener("keydown", e=> keys[e.key]=true);
document.addEventListener("keyup", e=> keys[e.key]=false);

function movePlayer(){
    if(keys["w"]) player.y -= player.speed;
    if(keys["s"]) player.y += player.speed;
    if(keys["a"]) player.x -= player.speed;
    if(keys["d"]) player.x += player.speed;

    // Angle towards movement
    if(keys["w"]||keys["s"]||keys["a"]||keys["d"])
        player.angle = Math.atan2(
            (keys["s"]?1:0) - (keys["w"]?1:0),
            (keys["d"]?1:0) - (keys["a"]?1:0)
        );

    // boundaries
    player.x = Math.max(20, Math.min(580, player.x));
    player.y = Math.max(20, Math.min(580, player.y));
}

function drawPlayer(){
    ctx.save();
    ctx.translate(player.x, player.y);
    ctx.rotate(player.angle);

    ctx.font="28px serif";
    ctx.fillText("ðŸ¤–", -15, 10);

    // suction field (triangle)
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(60,20);
    ctx.lineTo(60,-20);
    ctx.closePath();
    ctx.strokeStyle="rgba(0,255,255,0.4)";
    ctx.stroke();

    ctx.restore();
}

function drawNumbers(){
    ctx.fillStyle="white";
    for(let n of numbers){
        ctx.fillText(n.value, n.x, n.y);
    }
}

function checkSuction(){
    let newList=[];
    for(let n of numbers){
        let dx = n.x - player.x;
        let dy = n.y - player.y;
        let dist = Math.sqrt(dx*dx+dy*dy);

        if(dist < 60){ // suction radius
            score += n.value;
            document.getElementById("scoreText").innerText="Score: "+score;
        } else newList.push(n);
    }
    numbers = newList;
}

function gameLoop(){
    ctx.clearRect(0,0,600,600);

    movePlayer();
    drawPlayer();
    drawNumbers();
    checkSuction();
}

/* ---------------- END GAME ---------------- */
async function endGame(){
    clearInterval(interval);

    // save score
    await supabase.from("scores").insert({
        username: username,
        score: score
    });

    loadRanking();
}

async function loadRanking(){
    document.getElementById("game").style.display="none";
    document.getElementById("ranking").style.display="flex";

    let { data } = await supabase
        .from("scores")
        .select("*")
        .order("score",{ascending:false})
        .limit(10);

    let html="";
    data.forEach((r,i)=>{
        html += `<p>${i+1}. ${r.username} â€” ${r.score}</p>`;
    });

    document.getElementById("rankList").innerHTML=html;
}

function restart(){
    location.reload();
}
</script>

</body>
</html>
