<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Vacoomy</title>
  <style>
    body {
      margin: 0;
      background: #111;
      font-family: Arial;
      color: white;
      text-align: center;
      overflow: hidden;
    }
    #menu {
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translateX(-50%);
      width: 280px;
    }
    #username {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      text-align: center;
      border-radius: 8px;
      border: none;
      margin-bottom: 12px;
    }
    #startBtn {
      width: 100%;
      padding: 12px;
      font-size: 20px;
      background: #4CAF50;
      border: none;
      border-radius: 8px;
      color: white;
      cursor: pointer;
    }
    #gameCanvas { 
      display: none;
      background: #222;
    }
    #scoreBox, #timerBox {
      position: absolute;
      top: 10px;
      font-size: 24px;
    }
    #scoreBox { left: 10px; }
    #timerBox { right: 10px; }
    #ranking {
      display: none;
      position: absolute;
      top: 10%;
      width: 100%;
      text-align: center;
      font-size: 22px;
    }
  </style>
</head>

<body>

<div id="menu">
  <h1>Vacoomy</h1>
  <input id="username" placeholder="Enter username">
  <button id="startBtn">Start</button>
</div>

<div id="ranking">
  <h2>Global Ranking</h2>
  <div id="rankList"></div>
  <button onclick="reloadGame()">Play Again</button>
</div>

<canvas id="gameCanvas" width="900" height="600"></canvas>
<div id="scoreBox">Score: 0</div>
<div id="timerBox">120</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ---------- SUPABASE ---------- */
const SUPA_URL = "https://rwpzycqetqfeasveviho.supabase.co";
const SUPA_KEY = "sb_publishable_Bx5RBH5HrKmz8p8YRRH--Q_s-AYrwvt";
const supabase = supabase.createClient(SUPA_URL, SUPA_KEY);

/* ---------- DOM ELEMENTS ---------- */
const menu = document.getElementById("menu");
const rankingDiv = document.getElementById("ranking");
const rankList = document.getElementById("rankList");
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const scoreBox = document.getElementById("scoreBox");
const timerBox = document.getElementById("timerBox");

let username = "";
let score = 0;
let timeLeft = 120;

let robot = {
  x: 450, y: 300,
  speed: 4,
  size: 30,
  angle: 0
};

let keys = {};
let numbers = [];

/* ---------- INPUT ---------- */
document.addEventListener("keydown", e => keys[e.key] = true);
document.addEventListener("keyup", e => keys[e.key] = false);

/* ---------- START BUTTON ---------- */
document.getElementById("startBtn").onclick = () => {
  username = document.getElementById("username").value.trim();
  if (!username) { alert("Enter username"); return; }

  menu.style.display = "none";
  canvas.style.display = "block";
  score = 0;
  timeLeft = 120;
  numbers = [];

  spawnNumbers();
  gameLoop();
  startTimer();
};

/* ---------- GAME LOOP ---------- */
function gameLoop() {
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

function update() {
  if (keys["w"]) robot.y -= robot.speed;
  if (keys["s"]) robot.y += robot.speed;
  if (keys["a"]) robot.x -= robot.speed;
  if (keys["d"]) robot.x += robot.speed;

  let dx = 0, dy = 0;
  if (keys["w"]) dy = -1;
  if (keys["s"]) dy = 1;
  if (keys["a"]) dx = -1;
  if (keys["d"]) dx = 1;
  if (dx !== 0 || dy !== 0) robot.angle = Math.atan2(dy, dx);

  numbers.forEach((n, i) => {
    let dist = Math.hypot(robot.x - n.x, robot.y - n.y);
    if (dist < 60) {
      score += n.value;
      numbers.splice(i, 1);
    }
  });

  scoreBox.textContent = "Score: " + score;
}

/* ---------- DRAW ---------- */
function draw() {
  ctx.clearRect(0,0,900,600);

  // Numbers
  ctx.fillStyle = "yellow";
  numbers.forEach(n => {
    ctx.fillText(n.value, n.x, n.y);
  });

  // Robot Emoji
  ctx.save();
  ctx.translate(robot.x, robot.y);
  ctx.rotate(robot.angle);
  ctx.font = "40px serif";
  ctx.fillText("ðŸ¤–", -20, 15);

  // Attraction Cone
  ctx.fillStyle = "rgba(0,255,255,0.2)";
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(80, -40);
  ctx.lineTo(80, 40);
  ctx.closePath();
  ctx.fill();

  ctx.restore();
}

/* ---------- NUMBER SPAWN ---------- */
function spawnNumbers() {
  setInterval(() => {
    numbers.push({
      x: Math.random()*880+10,
      y: Math.random()*580+10,
      value: Math.floor(Math.random()*9)+1
    });
  }, 700);
}

/* ---------- TIMER ---------- */
function startTimer() {
  let t = setInterval(async () => {
    timeLeft--;
    timerBox.textContent = timeLeft;
    if (timeLeft <= 0) {
      clearInterval(t);
      await saveScore();
      await loadRanking();
    }
  }, 1000);
}

/* ---------- SUPABASE SAVE ---------- */
async function saveScore() {
  await supabase.from("scores").insert([{ username, score }]);
}

/* ---------- SUPABASE LOAD RANKING ---------- */
async function loadRanking() {
  canvas.style.display = "none";
  scoreBox.style.display = "none";
  timerBox.style.display = "none";

  rankingDiv.style.display = "block";

  const { data } = await supabase
    .from("scores")
    .select("*")
    .order("score", { ascending: false })
    .limit(10);

  rankList.innerHTML = data.map((r,i)=>`<div>${i+1}. ${r.username} - ${r.score}</div>`).join("");
}

/* ---------- RESTART ---------- */
function reloadGame() {
  location.reload();
}

</script>
</body>
</html>
