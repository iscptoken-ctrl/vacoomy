<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Vacoomy</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    body {
        margin: 0;
        background: #222;
        overflow: hidden;
        font-family: Arial, sans-serif;
        color: white;
        text-align: center;
    }
    #gameCanvas {
        background: #333;
        display:block;
        margin: 0 auto;
        border: 2px solid #555;
    }
    #ui {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 22px;
    }
    #startScreen, #endScreen, #nameScreen, #rankingScreen {
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
        background:#000c;
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        color:white;
        font-size:28px;
    }
    button {
        font-size:22px;
        padding:10px 20px;
        margin-top:20px;
        cursor:pointer;
    }
</style>
</head>
<body>

<div id="ui">Time: <span id="time">120</span> | Score: <span id="score">0</span></div>
<canvas id="gameCanvas" width="480" height="480"></canvas>

<!-- NAME SCREEN -->
<div id="nameScreen">
    <div>Enter your username</div>
    <input id="usernameInput" style="font-size:22px; padding:5px; margin-top:10px;" />
    <button onclick="saveName()">OK</button>
</div>

<!-- START SCREEN -->
<div id="startScreen" style="display:none">
    <div>Vacoomy</div>
    <button onclick="startGame()">Start</button>
    <button onclick="showRanking()">Global Ranking</button>
</div>

<!-- END SCREEN -->
<div id="endScreen" style="display:none">
    <div id="finalScore"></div>
    <button onclick="restart()">Play Again</button>
    <button onclick="showRanking()">Global Ranking</button>
</div>

<!-- RANKING -->
<div id="rankingScreen" style="display:none">
    <div>Global Ranking</div>
    <div id="rankList" style="margin-top:15px; font-size:20px;"></div>
    <button onclick="closeRanking()">Close</button>
</div>

<script>
// ----------------------
// SUPABASE CONFIG
// ----------------------
const SUPABASE_URL = "https://rwpzycqetqfeasveviho.supabase.co";
const SUPABASE_KEY = "sb_publishable_Bx5RBH5HrKmz8p8YRRH--Q_s-AYrwvt";

const supabase = supabasejs.createClient(SUPABASE_URL, SUPABASE_KEY);

// ----------------------
// GAME VARIABLES
// ----------------------
let username = "";
let canvas = document.getElementById("gameCanvas");
let ctx = canvas.getContext("2d");

let player = { x:240, y:240, size:22, speed:3 };
let score = 0;
let timeLeft = 120;
let numbers = [];

let keys = { w:false, a:false, s:false, d:false };
let running = false;
let timerInterval;

// ----------------------
// USERNAME SYSTEM
// ----------------------
function saveName(){
    let val = document.getElementById("usernameInput").value.trim();
    if(!val){ alert("Enter a valid name"); return; }
    username = val;
    document.getElementById("nameScreen").style.display = "none";
    document.getElementById("startScreen").style.display = "flex";
}

// ----------------------
// START GAME
// ----------------------
function startGame(){
    score = 0;
    timeLeft = 120;
    document.getElementById("score").textContent = score;
    document.getElementById("time").textContent = timeLeft;

    numbers = [];
    spawnLoop();

    running = true;

    document.getElementById("startScreen").style.display = "none";

    timerInterval = setInterval(()=>{
        timeLeft--;
        document.getElementById("time").textContent = timeLeft;
        if(timeLeft <= 0){
            endGame();
        }
    },1000);

    requestAnimationFrame(gameLoop);
}

// ----------------------
// END GAME + SAVE SCORE
// ----------------------
async function endGame(){
    running = false;
    clearInterval(timerInterval);

    // SAVE SCORE
    await supabase.from("scores").insert({
        username: username,
        score: score
    });

    document.getElementById("finalScore").textContent =
        "Your score: " + score;

    document.getElementById("endScreen").style.display = "flex";
}

function restart(){
    document.getElementById("endScreen").style.display = "none";
    document.getElementById("startScreen").style.display = "flex";
}

// ----------------------
// GLOBAL RANKING
// ----------------------
async function showRanking(){
    document.getElementById("rankingScreen").style.display = "flex";

    let { data, error } = await supabase
        .from("scores")
        .select("*")
        .order("score", { ascending:false })
        .limit(20);

    let list = "";
    data.forEach((r, i)=>{
        list += `${i+1}. ${r.username}: ${r.score}<br>`;
    });

    document.getElementById("rankList").innerHTML = list;
}

function closeRanking(){
    document.getElementById("rankingScreen").style.display = "none";
}

// ----------------------
// MOVEMENT
// ----------------------
document.addEventListener("keydown", e=>{
    if(e.key === "w") keys.w = true;
    if(e.key === "a") keys.a = true;
    if(e.key === "s") keys.s = true;
    if(e.key === "d") keys.d = true;
});
document.addEventListener("keyup", e=>{
    if(e.key === "w") keys.w = false;
    if(e.key === "a") keys.a = false;
    if(e.key === "s") keys.s = false;
    if(e.key === "d") keys.d = false;
});

// ----------------------
// SPAWN NUMBERS
// ----------------------
function spawnLoop(){
    setInterval(()=>{
        let n = {
            x: Math.random()*460+10,
            y: Math.random()*460+10,
            value: Math.floor(Math.random()*9)+1,
            life: 100
        };
        numbers.push(n);
    }, 400);
}

// ----------------------
// GAME LOOP
// ----------------------
function gameLoop(){
    if(!running) return;

    ctx.clearRect(0,0,480,480);

    // Move
    if(keys.w) player.y -= player.speed;
    if(keys.s) player.y += player.speed;
    if(keys.a) player.x -= player.speed;
    if(keys.d) player.x += player.speed;

    // Robot vacuum icon
    ctx.font = "26px serif";
    ctx.fillText("ðŸ¤–", player.x-15, player.y+10);

    // VACUUM RANGE VISUAL
    ctx.beginPath();
    ctx.arc(player.x, player.y, 40, 0, Math.PI*2);
    ctx.strokeStyle="yellow";
    ctx.stroke();

    // Draw numbers
    numbers.forEach((n,i)=>{
        ctx.fillStyle="white";
        ctx.font="20px Arial";
        ctx.fillText(n.value, n.x, n.y);

        let dx = n.x - player.x;
        let dy = n.y - player.y;
        let dist = Math.sqrt(dx*dx + dy*dy);

        if(dist < 40){
            score += n.value;
            document.getElementById("score").textContent = score;
            numbers.splice(i,1);
        }
    });

    requestAnimationFrame(gameLoop);
}

</script>
</body>
</html>
